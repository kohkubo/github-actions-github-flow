name: "Terraform ãƒ‡ãƒ—ãƒ­ã‚¤"

on:
  push:
    branches:
      - main
    paths:
      - 'terraform/**'
  pull_request:
    branches:
      - main
    paths:
      - 'terraform/**'
  workflow_dispatch:

jobs:
  terraform:
    name: "Terraform"
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: terraform

    steps:
      - name: ãƒªãƒã‚¸ãƒˆãƒªã®ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4

      - name: ç’°å¢ƒå¤‰æ•°ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹ã®ãƒ‡ãƒãƒƒã‚°
        run: |
          echo "GCP_PROJECT_ID: ${{ vars.GCP_PROJECT_ID }}"
          if [ -n "${{ secrets.GCP_SA_KEY }}" ]; then echo "GCP_SA_KEY is set"; else echo "GCP_SA_KEY is not set"; fi
      # æ–¹æ³•1: ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚­ãƒ¼ã‚’ä½¿ç”¨ã™ã‚‹æ–¹æ³•ï¼ˆæ¨å¥¨ï¼‰
      - name: Google Cloudã®èªè¨¼ã‚’è¨­å®šï¼ˆã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚­ãƒ¼ï¼‰
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      # æ–¹æ³•2: Workload Identity Federationã‚’ä½¿ç”¨ã™ã‚‹æ–¹æ³•ï¼ˆã‚ˆã‚Šå®‰å…¨ï¼‰
      # ã“ã®æ–¹æ³•ã‚’ä½¿ç”¨ã™ã‚‹å ´åˆã¯ã€ä»¥ä¸‹ã®æ‰‹é †ã§ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ãŒå¿…è¦ã§ã™:
      # https://github.com/google-github-actions/auth#setting-up-workload-identity-federation
      #- name: Google Cloudã®èªè¨¼ã‚’è¨­å®šï¼ˆWorkload Identityï¼‰
      #  uses: google-github-actions/auth@v2
      #  with:
      #    workload_identity_provider: 'projects/123456789/locations/global/workloadIdentityPools/my-pool/providers/my-provider'
      #    service_account: 'my-service-account@my-project.iam.gserviceaccount.com'

      - name: Google Cloudãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®è¨­å®š
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ vars.GCP_PROJECT_ID }}

      - name: Terraformã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.0.0

      - name: Terraformã®åˆæœŸåŒ–
        id: init
        run: terraform init

      - name: Terraformã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆæ¤œè¨¼
        id: fmt
        run: terraform fmt -check
        continue-on-error: true

      - name: Terraformã®æ¤œè¨¼
        id: validate
        run: terraform validate

      - name: Terraformãƒ—ãƒ©ãƒ³
        id: plan
        run: terraform plan -no-color -var="project_id=${{ vars.GCP_PROJECT_ID }}"
        continue-on-error: true

      - name: ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«ãƒ—ãƒ©ãƒ³ã‚’è¿½åŠ 
        uses: actions/github-script@v7
        if: github.event_name == 'pull_request'
        env:
          PLAN: "${{ steps.plan.outputs.stdout }}"
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const output = `#### Terraform Format and Style ğŸ–Œ\`${{ steps.fmt.outcome }}\`
            #### Terraform Validation ğŸ¤–\`${{ steps.validate.outcome }}\`
            #### Terraform Plan ğŸ“–\`${{ steps.plan.outcome }}\`

            <details><summary>è©³ç´°ã‚’è¡¨ç¤º</summary>

            \`\`\`terraform
            ${process.env.PLAN}
            \`\`\`

            </details>

            *å®Ÿè¡Œè€…: @${{ github.actor }}, ã‚¢ã‚¯ã‚·ãƒ§ãƒ³: \`${{ github.event_name }}\`*`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: output
            })

      - name: Terraformãƒ—ãƒ©ãƒ³ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
        if: steps.plan.outcome == 'failure'
        run: exit 1

      - name: Terraformã®é©ç”¨
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        run: terraform apply -auto-approve -var="project_id=${{ vars.GCP_PROJECT_ID }}"
